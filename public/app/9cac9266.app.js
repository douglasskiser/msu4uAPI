"use strict";angular.module("appApp",["ngCookies","ngResource","ngSanitize","ngAnimate","btford.socket-io","ui.router","ui.bootstrap","growlNotifications","angularFileUpload"]).config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider",function(a,b,c,d){b.otherwise("/"),c.html5Mode(!0),d.interceptors.push("authInterceptor")}]).factory("authInterceptor",["$rootScope","$q","$cookieStore","$location",function(a,b,c,d){return{request:function(a){return a.headers=a.headers||{},c.get("token")&&(a.headers.Authorization="Bearer "+c.get("token")),a},responseError:function(a){return 401===a.status?(d.path("/"),c.remove("token"),b.reject(a)):b.reject(a)}}}]).run(["$rootScope","$location","Auth",function(a,b,c){a.$on("$stateChangeStart",function(a,d){c.isLoggedInAsync(function(a){d.authenticate&&!a&&b.path("/")})})}]),angular.module("appApp").controller("AccountCtrl",["$scope","Modal","Auth","Notifications",function(a,b,c,d){a.user=angular.extend({},c.getCurrentUser()),a.updateAccount=function(b){b.$valid&&c.updateAccount(a.user.name,a.user.email).then(function(b){d.add({type:"success",message:"Your account has been updated."}),a.user=b})["catch"](function(){d.add({type:"danger",message:"There was an error updating your account."})})},a.changePassword=function(b){b.$valid&&(a.user.newPassword.length<5?a.errors="Password is too short.":a.user.newPassword!==a.user.confirm?a.errors="Confirmation does not match password.":c.changePassword(a.user.oldPassword,a.user.newPassword).then(function(){d.add({type:"success",message:"Your password has been changed."}),a.user.oldPassword="",a.user.newPassword="",a.user.confirm=""})["catch"](function(){d.add({type:"danger",message:"There was an error changing your password."})}))}}]),angular.module("appApp").config(["$stateProvider",function(a){a.state("account",{url:"/account",templateUrl:"app/admin/account/account.html",controller:"AccountCtrl",authenticate:!0})}]),angular.module("appApp").controller("AdminCtrl",["$scope","$location","Auth",function(a,b,c){a.isLoggedIn=c.isLoggedIn,a.isAdmin=c.isAdmin,a.getCurrentUser=c.getCurrentUser,a.logout=function(){c.logout(),b.path("/")}}]),angular.module("appApp").config(["$stateProvider",function(a){a.state("admin",{url:"/admin",templateUrl:"app/admin/admin.html",controller:"AdminCtrl",authenticate:!0})}]),angular.module("appApp").controller("AudioCtrl",["$scope","socket","Modal","Audio",function(a,b,c,d){a.audio=d.query(),a.addAudio=function(){c.audio.add()},a.removeAudio=function(b,d){c.audio["delete"](b,function(b){b&&a.audio.splice(d,1)})},b.socket.on("audio:update",function(b){a.audio.unshift(b)})}]),angular.module("appApp").config(["$stateProvider",function(a){a.state("audio",{url:"/audio",templateUrl:"app/admin/content/audio/audio.html",controller:"AudioCtrl",authenticate:!0})}]),angular.module("appApp").controller("ContentCtrl",["$scope",function(a){a.test="d"}]),angular.module("appApp").config(["$stateProvider",function(a){a.state("content",{url:"/content",templateUrl:"app/admin/content/content.html",controller:"ContentCtrl",authenticate:!0})}]),angular.module("appApp").controller("EventsCtrl",["$scope","Modal","Events",function(a,b,c){a.events=c.query(),a.addEvent=function(){b.events.add(function(b){b&&a.events.unshift(b)})},a.removeEvent=function(c,d){b.events["delete"](c,function(b){b&&a.events.splice(d,1)})},a.updateEvent=function(c,d){b.events.update(c,function(b){console.log(b),console.log(d),a.events.splice(d,1,b)})}}]),angular.module("appApp").config(["$stateProvider",function(a){a.state("events",{url:"/events",templateUrl:"app/admin/content/events/events.html",controller:"EventsCtrl",authenticate:!0})}]),angular.module("appApp").controller("UsersCtrl",["$scope","Modal","Auth","User",function(a,b,c,d){a.users=d.query(),a["delete"]=function(c){b.users["delete"](c,function(){angular.forEach(a.users,function(b,d){b===c&&a.users.splice(d,1)})})},a.addUser=function(){b.users.add(function(b){b&&a.users.push(b)})}}]),angular.module("appApp").config(["$stateProvider",function(a){a.state("users",{url:"/users",templateUrl:"app/admin/users/users.html",controller:"UsersCtrl",authenticate:!0})}]),angular.module("appApp").controller("MainCtrl",["$scope","$location","Auth",function(a,b,c){a.user={},a.errors={},c.isAdmin()&&b.path("/admin"),a.login=function(d){a.submitted=!0,d.$valid&&c.login({email:a.user.email,password:a.user.password}).then(function(){b.path("/admin")})["catch"](function(b){a.errors.other=b.message})}}]),angular.module("appApp").config(["$stateProvider",function(a){a.state("main",{url:"/",templateUrl:"app/main/main.html",controller:"MainCtrl"})}]),angular.module("appApp").factory("Audio",["$resource",function(a){return a("/api/audio/:id/",{id:"@_id"},{create:{method:"PUT",params:{}},get:{method:"GET",params:{}},remove:{method:"DELETE",params:{}}})}]),angular.module("appApp").factory("Auth",["$location","$rootScope","$http","User","$cookieStore","$q",function(a,b,c,d,e,f){var g={};return e.get("token")&&(g=d.get()),{login:function(a,b){var h=b||angular.noop,i=f.defer();return c.post("/auth/local",{email:a.email,password:a.password}).success(function(a){return e.put("token",a.token),g=d.get(),i.resolve(a),h()}).error(function(a){return this.logout(),i.reject(a),h(a)}.bind(this)),i.promise},logout:function(){e.remove("token"),g={}},createUser:function(a,b){var c=b||angular.noop;return d.save(a,function(a){return c(a)},function(a){return this.logout(),c(a)}.bind(this)).$promise},changePassword:function(a,b,c){var e=c||angular.noop;return d.changePassword({id:g._id},{oldPassword:a,newPassword:b},function(a){return e(a)},function(a){return e(a)}).$promise},updateAccount:function(a,b,c){var f=c||angular.noop;return d.updateAccount({id:g._id},{name:a,email:b},function(){return e.get("token")&&(g=d.get()),f(g)},function(a){return f(a)}).$promise},getCurrentUser:function(){return g},isLoggedIn:function(){return g.hasOwnProperty("role")},isLoggedInAsync:function(a){g.hasOwnProperty("$promise")?g.$promise.then(function(){a(!0)})["catch"](function(){a(!1)}):a(g.hasOwnProperty("role")?!0:!1)},isAdmin:function(){return"admin"===g.role},getToken:function(){return e.get("token")}}}]),angular.module("appApp").factory("User",["$resource",function(a){return a("/api/users/:id/:controller",{id:"@_id"},{changePassword:{method:"PUT",params:{controller:"password"}},get:{method:"GET",params:{id:"me"}},updateAccount:{method:"PUT",params:{controller:"account"}}})}]),angular.module("appApp").factory("Events",["$resource",function(a){return a("/api/events/:id/",{id:"@_id"},{get:{method:"GET",params:{}},remove:{method:"DELETE",params:{}},update:{method:"PUT",params:{}}})}]),angular.module("appApp").directive("fileInput",["$rootScope","socket","Notifications",function(a,b,c){return{replace:!0,restrict:"AE",templateUrl:"components/file-input/file-input.html",link:function(a){var d,e=window.ss,f=document.getElementById("browse-input");a.clientFile={selected:!1,progress:"",name:""},a.browseFile=function(){a.clientFile.progress="",f.click()},a.upload=function(){var c=e.createStream(),f=0;e(b.socket).emit("upload",c,{size:d.size,name:d.name.toString()});var g=e.createBlobReadStream(d);g.on("data",function(b){f+=b.length,a.clientFile.progress=Math.floor(f/d.size*100)+"%","100%"===a.clientFile.progress&&(a.clientFile.progress="Finished")}),g.pipe(c)},angular.element(f).on("change",function(b){d=b.target.files[0],a.$apply(function(){a.clientFile.name=d.name,a.clientFile.selected=!0})}),b.socket.on("upload:done",function(){c.add({type:"success",message:"Your file has been uploaded."})})}}}]),angular.module("appApp").factory("Modal",["$rootScope","$modal","Auth","User","Audio","Events","Notifications",function(a,b,c,d,e,f,g){function h(c,d){var e=a.$new();return c=c||{},d=d||"modal-default",angular.extend(e,c),b.open({templateUrl:"components/modal/modal.html",windowClass:d,scope:e})}return{confirm:{"delete":function(a){return a=a||angular.noop,function(){var b,c=Array.prototype.slice.call(arguments),d=c.shift();b=h({modal:{dismissable:!0,title:"Confirm Delete",html:"<p>Are you sure you want to delete <strong>"+d+"</strong> ?</p>",buttons:[{classes:"btn-danger",text:"Delete",click:function(a){b.close(a)}},{classes:"btn-default",text:"Cancel",click:function(a){b.dismiss(a)}}]}},"modal-danger"),b.result.then(function(b){a.apply(b,c)})}}},audio:{add:function(){return function(){var a;a=h({modal:{dismissable:!0,title:"Add Audio",upload:!0,buttons:[{classes:"btn-default",text:"Close",click:function(b){a.dismiss(b)}}]}})}()},"delete":function(a,b){return function(){var c;c=h({modal:{dismissable:!0,title:"Delete Audio",html:"<p>Are you sure you want to delete <strong>"+a.fileName+"</strong> ?</p>",buttons:[{classes:"btn-danger",text:"Delete",click:function(b){e.remove({id:a._id}),c.close(b,!0)}},{classes:"btn-default",text:"Close",click:function(a){c.dismiss(a,!1)}}]}}),c.result.then(function(a,c){return b(c)})}()}},events:{add:function(a){return a=a||angular.noop,function(){var b;b=h({modal:{dismissable:!0,title:"Add Event",form:"event",formModel:{name:"",description:"",date:"",time:"",location:""},datePickerIsOpen:!1,openDatePicker:function(a){a.preventDefault(),a.stopPropagation(),this.datePickerIsOpen=!0},buttons:[{classes:"btn-default",text:"Cancel",click:function(a){b.dismiss(a)}},{classes:"btn-primary",text:"Save",passData:!0,click:function(a){f.save({name:a.name,description:a.description,date:a.date,time:a.time,location:a.location},function(a){g.add({type:"success",message:"Event has been added."}),b.close(a)},function(){g.add({type:"danger",message:"There was error adding the event."})})}}]}},"modal-default"),b.result.then(function(b){return b.name?a(b):a()})}()},update:function(a,b){return b=b||angular.noop,function(){var c;c=h({modal:{dismissable:!0,title:"Add Event",form:"event",formModel:{name:a.name,description:a.description,date:a.date,time:a.time,location:a.location,_id:a._id},datePickerIsOpen:!1,openDatePicker:function(a){a.preventDefault(),a.stopPropagation(),this.datePickerIsOpen=!0},buttons:[{classes:"btn-default",text:"Cancel",click:function(a){c.dismiss(a)}},{classes:"btn-primary",text:"Update",passData:!0,click:function(b){f.update({id:a._id},{name:b.name,description:b.description,date:b.date,time:b.time,location:b.location},function(a){g.add({type:"success",message:"Event has been updated."}),c.close(a)},function(){g.add({type:"danger",message:"There was error updating the event."})})}}]}},"modal-default"),c.result.then(function(a){return a.name?b(a):b()})}()},"delete":function(a,b){return function(){var c;c=h({modal:{dismissable:!0,title:"Delete Event",html:"<p>Are you sure you want to delete <strong>"+a.name+"</strong> ?</p>",buttons:[{classes:"btn-danger",text:"Delete",click:function(b){f.remove({id:a._id},function(){c.close(b,!0)})}},{classes:"btn-default",text:"Close",click:function(a){c.dismiss(a,!1)}}]}}),c.result.then(function(a,c){return b(c)})}()}},users:{add:function(a){return a=a||angular.noop,function(){var b;b=h({modal:{dismissable:!0,title:"Add User",form:"addUser",formModel:{username:"",email:"",password:"",confirm:""},buttons:[{classes:"btn-primary",text:"Save",passData:!0,click:function(a){a.password.length<5?a.errors="Password is too short.":a.password!==a.confirm?a.errors="Confirmation does not match password.":c.createUser({name:a.username,email:a.email,password:a.password}).then(function(a){g.add({type:"success",message:"User has been added."}),b.close(a)})["catch"](function(){g.add({type:"danger",message:"There was error adding user."})})}},{classes:"btn-default",text:"Cancel",click:function(a){b.dismiss(a)}}]}},"modal-default"),b.result.then(function(b){return b.email?a(b):a()})}()},"delete":function(a,b){return b=b||angular.noop,function(){var c;c=h({modal:{dismissable:!0,title:"Confirm delete",html:"<p>Are you sure you want to delete <strong>"+a.name+"</strong> ?</p>",buttons:[{classes:"btn-danger",text:"Delete",click:function(){d.remove({id:a._id}),g.add({type:"success",message:"User has been deleted."}),c.close()}},{classes:"btn-default",text:"Cancel",click:function(){c.dismiss()}}]}},"modal-danger"),c.result.then(function(){b.apply()})}()}}}}]),angular.module("appApp").directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){b.on("keydown",function(){return d.$setValidity("mongoose",!0)})}}}),angular.module("appApp").controller("NavbarCtrl",["$scope","$location","Auth",function(a,b,c){a.isCollapsed=!0,a.isLoggedIn=c.isLoggedIn,a.isAdmin=c.isAdmin,a.getCurrentUser=c.getCurrentUser().name,a.logout=function(){c.logout(),b.path("/")},a.isActive=function(a){return a===b.path()}}]),angular.module("appApp").controller("NotificationsCtrl",["$scope","Notifications",function(a,b){a.notifications=b.list}]),angular.module("appApp").service("Notifications",function(){this.list=[],this.add=function(a){return this.list.push(a)}}),angular.module("appApp").factory("socket",["socketFactory",function(a){var b=io("",{path:"/socket.io-client"}),c=a({ioSocket:b});return{socket:c}}]),angular.module("appApp").run(["$templateCache",function(a){a.put("app/admin/account/account.html",'<div ng-include="\'components/navbar/navbar.html\'"></div><div class=container><div class="panel panel-default"><div class="panel-heading users-panel-heading"><span class=users-panel-title>My Account</span></div><div class=panel-body><h2>Update Account</h2><hr><form name=accountForm class=form novalidate><div class=form-group><input class=form-control name=name ng-model="user.name"></div><div class=form-group><input class=form-control type=email name=email ng-model="user.email"></div><button class="btn btn-primary pull-right" ng-click=updateAccount(accountForm)>Update Account</button></form><br><h2>Change Password</h2><hr><form name=passwordForm class=form novalidate><div class=form-group><input class=form-control type=password name=oldpassword placeholder="Old Password" ng-model="user.oldPassword"></div><div class=form-group><input class=form-control type=password name=newpassword placeholder="New Password" ng-model="user.newPassword"></div><div class=form-group><input class=form-control type=password name=confirm placeholder="Confirm Password" ng-model="user.confirm"></div><button class="btn btn-primary pull-right" ng-click=changePassword(passwordForm)>Change Password</button></form></div></div></div>'),a.put("app/admin/admin.html",'<div ng-include="\'components/navbar/navbar.html\'"></div><div class=admin-container><div class=container><a href=/users><div class="admin-users col-xs-12 col-sm-5 col-sm-offset-1"><div class=admin-users-inner><div class="admin-users-icon fa fa-users"></div><p class=admin-users-title>User Management</p></div></div></a> <a href=/content><div class="admin-content col-xs-12 col-sm-5"><div class=admin-content-inner><div class="admin-content-icon fa fa-file"></div><p class=admin-content-title>Content Management</p></div></div></a></div></div>'),a.put("app/admin/content/audio/audio.html",'<div ng-include="\'components/navbar/navbar.html\'"></div><div class=container><div class="panel panel-default"><div class="panel-heading audio-panel-heading"><button class="btn btn-default pull-right add-audio-btn" ng-click=addAudio()>Add Audio</button><span class=audio-panel-title>Audio Management</span></div><div class=panel-body><ul class=list-group><li class="list-group-item pointer" ng-repeat="clip in audio"><a ng-click="removeAudio(clip, $index)" class=trash><span class="glyphicon glyphicon-trash pull-right"></span></a>{{clip.fileName}}</li></ul></div></div></div>'),a.put("app/admin/content/content.html",'<div ng-include="\'components/navbar/navbar.html\'"></div><div class=container><div class="panel panel-default"><div class="panel-heading users-panel-heading"><span class=users-panel-title>Manage Content</span></div><div class=panel-body><ul class=list-group><li class="list-group-item pointer" ui-sref=events><span class="fa fa-chevron-right pull-right content-chevron"></span>Events</li><li class="list-group-item pointer" ui-sref=audio><span class="fa fa-chevron-right pull-right content-chevron"></span>Audio</li></ul></div></div><!--\n    <file-input></file-input>\n    <form ng-submit="uploadFile()">\n        <input type="file" ng-model="files" ng-file-select="onFileSelect(files)" ng-multiple="false" class="app-prompt-upload" />\n    </form>\n--></div>'),a.put("app/admin/content/events/events.html",'<div ng-include="\'components/navbar/navbar.html\'"></div><div class=container><div class="panel panel-default"><div class="panel-heading events-panel-heading"><button class="btn btn-default pull-right add-events-btn" ng-click=addEvent()>Add Event</button><span class=events-panel-title>Events Management</span></div><div class=panel-body><ul class=list-group><li class="list-group-item pointer" ng-repeat="evt in events"><span class=pull-right><a ng-click="updateEvent(evt, $index)"><span class="glyphicon glyphicon-pencil"></span></a> <a ng-click="removeEvent(evt, $index)" class=trash><span class="glyphicon glyphicon-trash"></span></a></span>{{evt.name}}</li></ul></div></div></div>'),a.put("app/admin/users/users.html",'<div ng-include="\'components/navbar/navbar.html\'"></div><div class=container><div class="panel panel-default"><div class="panel-heading users-panel-heading"><button class="btn btn-default pull-right add-user-btn" ng-click=addUser()>Add User</button><span class=users-panel-title>Manage Users</span></div><div class=panel-body><ul class=list-group><li class=list-group-item ng-repeat="user in users"><strong>{{user.name}}</strong><br><span class=text-muted>{{user.email}}</span> <a ng-click=delete(user) class=trash><span class="glyphicon glyphicon-trash pull-right"></span></a></li></ul></div></div></div>'),a.put("app/main/main.html",'<div class=login-container><div class=login-header></div><div class=login-body><form class=form name=form novalidate><div class=form-group><input class=form-control placeholder=Email ng-model="user.email"></div><div class=form-group><input class=form-control type=password placeholder=Password ng-model="user.password"></div></form></div><div class=login-footer><button class="btn btn-primary" type=button ng-click=login(form)>Login</button></div></div><div class="login-errors has-error"><p class=help-block ng-show="form.email.$error.required && form.password.$error.required && submitted">Please enter your email and password.</p><p class=help-block ng-show="form.email.$error.email && submitted">Please enter a valid email.</p><p class=help-block>{{ errors.other }}</p></div>'),a.put("components/file-input/file-input.html",'<div class=file-input-container><input type=file id=browse-input accept="audio/*"><p class=text-center><button class="btn btn-default" id=browse-btn ng-click=browseFile()>Choose File</button> <button class="btn btn-default" id=upload-btn ng-click=upload() ng-disabled=!clientFile.selected>Upload File</button></p><p class=text-center ng-show="clientFile.name != \'\'">Filename: {{clientFile.name}}</p><p class=text-center ng-show="clientFile.progress != \'\'">Uploaded: {{clientFile.progress}}</p></div>'),a.put("components/modal/modal.html",'<div class=modal-header><button ng-if=modal.dismissable type=button ng-click=$dismiss() class=close>&times;</button><h4 ng-if=modal.title ng-bind=modal.title class=modal-title></h4></div><div class=modal-body><p ng-if=modal.text ng-bind=modal.text></p><div ng-if=modal.html ng-bind-html=modal.html></div><div ng-if="modal.form == \'addUser\'"><form name=addUserForm class=form novalidate><div class=form-group><input class=form-control name=username placeholder=Username ng-model="modal.formModel.username"></div><div class=form-group><input class=form-control type=email name=email placeholder=Email ng-model="modal.formModel.email"></div><div class=form-group><input class=form-control type=password name=password placeholder=Password ng-model="modal.formModel.password"></div><div class=form-group><input class=form-control type=password name=confirm placeholder="Confirm Password" ng-model="modal.formModel.confirm"></div><p class="text-danger text-center" ng-if=modal.formModel.errors>{{modal.formModel.errors}}</p></form></div><div ng-if="modal.form == \'event\'"><form name=addEventForm class=form novalidate><div class=form-group><input class=form-control name=name placeholder="Event Name" ng-model="modal.formModel.name"></div><div class=form-group><textarea class=form-control name=description placeholder=Description ng-model=modal.formModel.description></textarea></div><div class=form-group><p class=input-group><input class=form-control name=date placeholder=Date ng-model=modal.formModel.date datepicker-popup=dd-MMMM-yyyy is-open="modal.datePickerIsOpen"> <span class=input-group-btn><button type=button class="btn btn-default" ng-click=modal.openDatePicker($event)><i class="glyphicon glyphicon-calendar"></i></button></span></p></div><div class=form-group><input class=form-control name=time placeholder=Time ng-model="modal.formModel.time"></div><div class=form-group><input class=form-control name=location placeholder=Location ng-model="modal.formModel.location"></div><p class="text-danger text-center" ng-if=modal.formModel.errors>{{modal.formModel.errors}}</p></form></div><div ng-if=modal.upload><file-input></file-input></div></div><div class=modal-footer><span ng-repeat="button in modal.buttons"><button ng-if=button.passData ng-class=button.classes ng-click=button.click(modal.formModel) ng-bind=button.text class=btn></button><button ng-if=!button.passData ng-class=button.classes ng-click=button.click($event) ng-bind=button.text class=btn></button></span></div>'),a.put("components/navbar/navbar.html",'<div class="navbar navbar-default navbar-static-top" ng-controller=NavbarCtrl><div class=container><div class=navbar-header><button class=navbar-toggle type=button ng-click="isCollapsed = !isCollapsed"><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="/" class=navbar-brand>MSU4U</a></div><div collapse=isCollapsed class="navbar-collapse collapse" id=navbar-main><ul class="nav navbar-nav"><li ng-show=isAdmin() ng-class="{active: isActive(\'/admin\')}"><a href=/admin>Admin</a></li><li ng-show=isAdmin() ng-class="{active: isActive(\'/users\')}"><a href=/users>User Management</a></li><li ng-show=isAdmin() ng-class="{active: isActive(\'/content\')}"><a href=/content>Content Management</a></li></ul><ul class="nav navbar-nav navbar-right"><li ng-show=isLoggedIn()><p class=navbar-text>Hello {{ getCurrentUser }}</p></li><li ng-show=isLoggedIn() ng-class="{active: isActive(\'/account\')}"><a href=/account><span class="glyphicon glyphicon-cog"></span></a></li><li ng-show=isLoggedIn() ng-class="{active: isActive(\'/logout\')}"><a href="" ng-click=logout()>Logout</a></li></ul></div></div></div>'),a.put("components/notifications/notifications.html",'<span ng-controller=NotificationsCtrl class=notification-container><ul growl-notifications class=growl-notifications></ul><div ng-repeat="notification in notifications track by $id($index)"><div growl-notification class="alert alert-{{notification.type}} fading growl-notification">{{notification.message}}</div></div></span>')}]);